'use strict';

// https://raw.githubusercontent.com/lemieuxster/node-aco/master/aco.js
// http://www.nomodes.com/aco.html

var fs = require('fs');
var colorException = {};

//ACO files take 16 bit words.
function writeValue(writeStream, value) {
	var buffer = Buffer.alloc(2);

	buffer.writeUInt16BE(value, 0);
	writeStream.write(buffer);
}

//Convenient way to write RGB integer values. Expected with this multiplier.
function writeRGBValue(writeStream, value) {
	writeValue(writeStream, value < 128 ? value * 256 : 255 + value * 256);
}

//Convenient for adding zero
function writeZero(writeStream) {
	writeValue(writeStream, 0);
}

function sanitizeFilename(filename) {
	filename = filename || 'aco-' + new Date() + '.aco';
	if (filename.lastIndexOf('.aco') !== filename.length - 4) filename = filename + '.aco';
	return filename;
}

function hexToRgb(hex) {
	var match = hex.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);
	if (!match) {
		return [0, 0, 0];
	}

	var colorString = match[0];

	if (match[0].length === 3) {
		colorString = colorString.split('').map(function (char) {
			return char + char;
		}).join('');
	}

	var integer = parseInt(colorString, 16);
	var r = integer >> 16 & 0xFF;
	var g = integer >> 8 & 0xFF;
	var b = integer & 0xFF;

	return [r, g, b];
};

function writeColors(aco, colors, writeNames) {
	colors.forEach(function (colorInfo) {
		try {
			var hex = colorInfo.color;
			var name = colorInfo.name || hex;

			//Parse RGB
			var rgb = hexToRgb(hex);
			rgb = rgb.filter(function (value) {
				return !isNaN(value);
			});

			//Make sure we have valid values
			if (rgb.length < 3) {
				throw colorException;
			}

			writeZero(aco); //Write 0, for RGB color space
			writeRGBValue(aco, rgb[0]); //R
			writeRGBValue(aco, rgb[1]); //G
			writeRGBValue(aco, rgb[2]); //B
			writeZero(aco); //Pad (we need w, x, y, and z values. RGB only has w, x, y - so z is zero.

			// Only required in v2 ACO
			if (writeNames) {
				writeZero(aco);
				writeValue(aco, name.length + 1);
				for (var i = 0, l = name.length; i < l; i++) {
					writeValue(aco, name.charCodeAt(i));
				}
				writeZero(aco);
			}
		} catch (e) {
			var error = "Parse Error";
			if (e === colorException) {
				error = "Invalid Color";
			}

			if (callback && 'function' === typeof callback) {
				callback(error);
			} else {
				throw new Error(error);
			}
		}
	});
}

exports.make = function (filename, colors, callback) {
	filename = sanitizeFilename(filename);

	colors = colors instanceof Array ? colors : [];

	var aco = fs.createWriteStream(filename);

	// Write version 1 ACO
	writeValue(aco, 1);
	writeValue(aco, colors.length);
	writeColors(aco, colors, false);

	// Version 2 ACO
	writeValue(aco, 2);
	writeValue(aco, colors.length);
	writeColors(aco, colors, true);

	aco.end();

	if (callback && 'function' === typeof callback) {
		callback(null, aco);
	}
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvYWNvV3JpdGVyLmpzIl0sIm5hbWVzIjpbImZzIiwicmVxdWlyZSIsImNvbG9yRXhjZXB0aW9uIiwid3JpdGVWYWx1ZSIsIndyaXRlU3RyZWFtIiwidmFsdWUiLCJidWZmZXIiLCJCdWZmZXIiLCJhbGxvYyIsIndyaXRlVUludDE2QkUiLCJ3cml0ZSIsIndyaXRlUkdCVmFsdWUiLCJ3cml0ZVplcm8iLCJzYW5pdGl6ZUZpbGVuYW1lIiwiZmlsZW5hbWUiLCJEYXRlIiwibGFzdEluZGV4T2YiLCJsZW5ndGgiLCJoZXhUb1JnYiIsImhleCIsIm1hdGNoIiwidG9TdHJpbmciLCJjb2xvclN0cmluZyIsInNwbGl0IiwibWFwIiwiY2hhciIsImpvaW4iLCJpbnRlZ2VyIiwicGFyc2VJbnQiLCJyIiwiZyIsImIiLCJ3cml0ZUNvbG9ycyIsImFjbyIsImNvbG9ycyIsIndyaXRlTmFtZXMiLCJmb3JFYWNoIiwiY29sb3JJbmZvIiwiY29sb3IiLCJuYW1lIiwicmdiIiwiZmlsdGVyIiwiaXNOYU4iLCJpIiwibCIsImNoYXJDb2RlQXQiLCJlIiwiZXJyb3IiLCJjYWxsYmFjayIsIkVycm9yIiwiZXhwb3J0cyIsIm1ha2UiLCJBcnJheSIsImNyZWF0ZVdyaXRlU3RyZWFtIiwiZW5kIl0sIm1hcHBpbmdzIjoiOztBQUFBO0FBQ0E7O0FBRUEsSUFBSUEsS0FBS0MsUUFBUSxJQUFSLENBQVQ7QUFDQSxJQUFJQyxpQkFBaUIsRUFBckI7O0FBRUE7QUFDQSxTQUFTQyxVQUFULENBQW9CQyxXQUFwQixFQUFpQ0MsS0FBakMsRUFBd0M7QUFDdkMsS0FBSUMsU0FBU0MsT0FBT0MsS0FBUCxDQUFhLENBQWIsQ0FBYjs7QUFFQUYsUUFBT0csYUFBUCxDQUFxQkosS0FBckIsRUFBNEIsQ0FBNUI7QUFDQUQsYUFBWU0sS0FBWixDQUFrQkosTUFBbEI7QUFDQTs7QUFFRDtBQUNBLFNBQVNLLGFBQVQsQ0FBdUJQLFdBQXZCLEVBQW9DQyxLQUFwQyxFQUEyQztBQUMx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L3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vbGVtaWV1eHN0ZXIvbm9kZS1hY28vbWFzdGVyL2Fjby5qc1xuLy8gaHR0cDovL3d3dy5ub21vZGVzLmNvbS9hY28uaHRtbFxuXG52YXIgZnMgPSByZXF1aXJlKCdmcycpO1xudmFyIGNvbG9yRXhjZXB0aW9uID0ge307XG5cbi8vQUNPIGZpbGVzIHRha2UgMTYgYml0IHdvcmRzLlxuZnVuY3Rpb24gd3JpdGVWYWx1ZSh3cml0ZVN0cmVhbSwgdmFsdWUpIHtcblx0dmFyIGJ1ZmZlciA9IEJ1ZmZlci5hbGxvYygyKTtcblxuXHRidWZmZXIud3JpdGVVSW50MTZCRSh2YWx1ZSwgMCk7XG5cdHdyaXRlU3RyZWFtLndyaXRlKGJ1ZmZlcik7XG59XG5cbi8vQ29udmVuaWVudCB3YXkgdG8gd3JpdGUgUkdCIGludGVnZXIgdmFsdWVzLiBFeHBlY3RlZCB3aXRoIHRoaXMgbXVsdGlwbGllci5cbmZ1bmN0aW9uIHdyaXRlUkdCVmFsdWUod3JpdGVTdHJlYW0sIHZhbHVlKSB7XG5cdHdyaXRlVmFsdWUod3JpdGVTdHJlYW0sIHZhbHVlIDwgMTI4ID8gdmFsdWUgKiAyNTYgOiAyNTUgKyB2YWx1ZSAqIDI1Nik7XG59XG5cbi8vQ29udmVuaWVudCBmb3IgYWRkaW5nIHplcm9cbmZ1bmN0aW9uIHdyaXRlWmVybyh3cml0ZVN0cmVhbSkge1xuXHR3cml0ZVZhbHVlKHdyaXRlU3RyZWFtLCAwKTtcbn1cblxuZnVuY3Rpb24gc2FuaXRpemVGaWxlbmFtZShmaWxlbmFtZSkge1xuXHRmaWxlbmFtZSA9IGZpbGVuYW1lIHx8ICdhY28tJyArIG5ldyBEYXRlKCkgKyAnLmFjbyc7XG5cdGlmIChmaWxlbmFtZS5sYXN0SW5kZXhPZignLmFjbycpICE9PSBmaWxlbmFtZS5sZW5ndGggLSA0KSBmaWxlbmFtZSA9IGZpbGVuYW1lICsgJy5hY28nO1xuXHRyZXR1cm4gZmlsZW5hbWU7XG59XG5cbmZ1bmN0aW9uIGhleFRvUmdiKGhleCkge1xuXHR2YXIgbWF0Y2ggPSBoZXgudG9TdHJpbmcoMTYpLm1hdGNoKC9bYS1mMC05XXs2fXxbYS1mMC05XXszfS9pKTtcblx0aWYgKCFtYXRjaCkge1xuXHRcdHJldHVybiBbMCwgMCwgMF07XG5cdH1cblxuXHR2YXIgY29sb3JTdHJpbmcgPSBtYXRjaFswXTtcblxuXHRpZiAobWF0Y2hbMF0ubGVuZ3RoID09PSAzKSB7XG5cdFx0Y29sb3JTdHJpbmcgPSBjb2xvclN0cmluZy5zcGxpdCgnJykubWFwKGZ1bmN0aW9uIChjaGFyKSB7XG5cdFx0XHRyZXR1cm4gY2hhciArIGNoYXI7XG5cdFx0fSkuam9pbignJyk7XG5cdH1cblxuXHR2YXIgaW50ZWdlciA9IHBhcnNlSW50KGNvbG9yU3RyaW5nLCAxNik7XG5cdHZhciByID0gKGludGVnZXIgPj4gMTYpICYgMHhGRjtcblx0dmFyIGcgPSAoaW50ZWdlciA+PiA4KSAmIDB4RkY7XG5cdHZhciBiID0gaW50ZWdlciAmIDB4RkY7XG5cblx0cmV0dXJuIFtyLCBnLCBiXTtcbn07XG5cbmZ1bmN0aW9uIHdyaXRlQ29sb3JzKGFjbywgY29sb3JzLCB3cml0ZU5hbWVzKSB7XG5cdGNvbG9ycy5mb3JFYWNoKGZ1bmN0aW9uKGNvbG9ySW5mbykge1xuXHRcdHRyeSB7XG5cdFx0XHR2YXIgaGV4ID0gY29sb3JJbmZvLmNvbG9yO1xuXHRcdFx0dmFyIG5hbWUgPSBjb2xvckluZm8ubmFtZSB8fCBoZXg7XG5cblx0XHRcdC8vUGFyc2UgUkdCXG5cdFx0XHR2YXIgcmdiID0gaGV4VG9SZ2IoaGV4KTtcblx0XHRcdHJnYiA9IHJnYi5maWx0ZXIoZnVuY3Rpb24odmFsdWUpIHtcblx0XHRcdFx0cmV0dXJuICFpc05hTih2YWx1ZSk7XG5cdFx0XHR9KTtcblxuXHRcdFx0Ly9NYWtlIHN1cmUgd2UgaGF2ZSB2YWxpZCB2YWx1ZXNcblx0XHRcdGlmIChyZ2IubGVuZ3RoIDwgMykge1xuXHRcdFx0XHR0aHJvdyBjb2xvckV4Y2VwdGlvbjtcblx0XHRcdH1cblxuXHRcdFx0d3JpdGVaZXJvKGFjbyk7IC8vV3JpdGUgMCwgZm9yIFJHQiBjb2xvciBzcGFjZVxuXHRcdFx0d3JpdGVSR0JWYWx1ZShhY28sIHJnYlswXSk7IC8vUlxuXHRcdFx0d3JpdGVSR0JWYWx1ZShhY28sIHJnYlsxXSk7IC8vR1xuXHRcdFx0d3JpdGVSR0JWYWx1ZShhY28sIHJnYlsyXSk7IC8vQlxuXHRcdFx0d3JpdGVaZXJvKGFjbyk7IC8vUGFkICh3ZSBuZWVkIHcsIHgsIHksIGFuZCB6IHZhbHVlcy4gUkdCIG9ubHkgaGFzIHcsIHgsIHkgLSBzbyB6IGlzIHplcm8uXG5cblx0XHRcdC8vIE9ubHkgcmVxdWlyZWQgaW4gdjIgQUNPXG5cdFx0XHRpZiAod3JpdGVOYW1lcykge1xuXHRcdFx0XHR3cml0ZVplcm8oYWNvKTtcblx0XHRcdFx0d3JpdGVWYWx1ZShhY28sIG5hbWUubGVuZ3RoICsgMSk7XG5cdFx0XHRcdGZvciAodmFyIGkgPSAwLCBsID0gbmFtZS5sZW5ndGg7IGkgPCBsOyBpKyspIHtcblx0XHRcdFx0XHR3cml0ZVZhbHVlKGFjbywgbmFtZS5jaGFyQ29kZUF0KGkpKTtcblx0XHRcdFx0fVxuXHRcdFx0XHR3cml0ZVplcm8oYWNvKTtcblx0XHRcdH1cblx0XHR9IGNhdGNoIChlKSB7XG5cdFx0XHR2YXIgZXJyb3IgPSBcIlBhcnNlIEVycm9yXCI7XG5cdFx0XHRpZiAoZSA9PT0gY29sb3JFeGNlcHRpb24pIHtcblx0XHRcdFx0ZXJyb3IgPSBcIkludmFsaWQgQ29sb3JcIjtcblx0XHRcdH1cblxuXHRcdFx0aWYgKGNhbGxiYWNrICYmICdmdW5jdGlvbicgPT09IHR5cGVvZiBjYWxsYmFjaykge1xuXHRcdFx0XHRjYWxsYmFjayhlcnJvcik7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoZXJyb3IpO1xuXHRcdFx0fVxuXHRcdH1cblxuXHR9KTtcbn1cblxuZXhwb3J0cy5tYWtlID0gZnVuY3Rpb24oZmlsZW5hbWUsIGNvbG9ycywgY2FsbGJhY2spIHtcblx0ZmlsZW5hbWUgPSBzYW5pdGl6ZUZpbGVuYW1lKGZpbGVuYW1lKTtcblxuXHRjb2xvcnMgPSBjb2xvcnMgaW5zdGFuY2VvZiBBcnJheSA/IGNvbG9ycyA6IFtdO1xuXG5cdHZhciBhY28gPSBmcy5jcmVhdGVXcml0ZVN0cmVhbShmaWxlbmFtZSk7XG5cblx0Ly8gV3JpdGUgdmVyc2lvbiAxIEFDT1xuXHR3cml0ZVZhbHVlKGFjbywgMSk7XG5cdHdyaXRlVmFsdWUoYWNvLCBjb2xvcnMubGVuZ3RoKTtcblx0d3JpdGVDb2xvcnMoYWNvLCBjb2xvcnMsIGZhbHNlKTtcblxuXHQvLyBWZXJzaW9uIDIgQUNPXG5cdHdyaXRlVmFsdWUoYWNvLCAyKTtcblx0d3JpdGVWYWx1ZShhY28sIGNvbG9ycy5sZW5ndGgpO1xuXHR3cml0ZUNvbG9ycyhhY28sIGNvbG9ycywgdHJ1ZSk7XG5cblx0YWNvLmVuZCgpO1xuXG5cdGlmIChjYWxsYmFjayAmJiAnZnVuY3Rpb24nID09PSB0eXBlb2YgY2FsbGJhY2spIHtcblx0XHRjYWxsYmFjayhudWxsLCBhY28pO1xuXHR9XG59OyJdfQ==